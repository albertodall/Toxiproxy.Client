trigger:
  branches:
    include:
    - main
    - release/*
  tags:
    include:
    - v*
  paths:
    exclude:
    - '*.yml'
    - global.json
    - sample/**
    - LICENSE
    - README.md

pr:
  branches:
    include:
    - main
    - release/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1

stages:
- stage: Build
  displayName: 'Build and test'
  jobs:
  - job: Build
    displayName: 'Build library and run tests'
    steps:
    - checkout: self
      fetchDepth: 0
      fetchTags: true

    - task: UseDotNet@2
      displayName: 'Install .NET SDK'
      inputs:
        packageType: 'sdk'
        useGlobalJson: true
        performMultiLevelLookup: true

    - task: DotNetCoreCLI@2
      displayName: 'Install MinVer tool'
      inputs:
        command: 'custom'
        custom: 'tool'
        arguments: 'install --global minver-cli'

    - bash: |
        VERSION=$(minver -m 0.1 -p preview)
        echo "Calculated version: $VERSION"
        echo "##vso[task.setvariable variable=PackageVersion;isOutput=true]$VERSION"
        if [[ "$VERSION" == *"-preview."* ]]; then
          echo "Building a preview version"
          echo "##vso[task.setvariable variable=IsPreviewVersion;isOutput=true]true"
        else
          echo "Building a stable version"
        fi
      name: CalculatePackageVersion
      displayName: 'Calculate package version'
    
    - task: DotNetCoreCLI@2
      displayName: 'Restore NuGet packages'
      inputs:
        command: 'restore'
        projects: '**/Toxiproxy.Client.slnx'
    
    - task: DotNetCoreCLI@2
      displayName: "Build solution"
      inputs:
        command: 'build'
        arguments: '--configuration $(buildConfiguration) --no-restore'
        projects: '**/Toxiproxy.Client.slnx'
    
    - task: DockerCompose@1
      displayName: 'Start containers for tests'
      inputs:
        containerregistrytype: 'Container Registry'
        projectName: 'toxiproxy-client'
        action: 'Run a Docker Compose command'
        dockerComposeCommand: 'up -d'
    
    - task: DotNetCoreCLI@2
      displayName: 'Run tests'
      inputs:
        command: 'test'
        projects: '**/Toxiproxy.Client.Tests.csproj'
        arguments: '--configuration $(buildConfiguration) --no-build --no-restore'
        publishTestResults: true

    - task: DockerCompose@1
      displayName: 'Stop containers for tests'
      inputs:
        containerregistrytype: 'Container Registry'
        projectName: 'toxiproxy-client'
        action: 'Run a Docker Compose command'
        dockerComposeCommand: 'down -v'
      condition: always()

    - task: DotNetCoreCLI@2
      displayName: 'Create NuGet package'
      inputs:
        command: 'pack'
        packagesToPack: '**/Toxiproxy.Client.csproj'
        configuration: '$(buildConfiguration)'
        nobuild: true
        versioningScheme: 'byEnvVar'
        versionEnvVar: 'CalculatePackageVersion.PackageVersion'

    - task: PublishPipelineArtifact@1
      displayName: Publish NuGet package artifact
      inputs:
        targetPath: '$(Build.ArtifactStagingDirectory)'
        artifact: 'NuGetPackage'
        publishLocation: 'pipeline'
